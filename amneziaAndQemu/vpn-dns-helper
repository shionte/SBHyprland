#!/bin/bash

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ root
if [ "$(id -u)" != "0" ]; then
    echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å –ø—Ä–∞–≤–∞–º–∏ root: sudo $0"
    exit 1
fi

case "$1" in
    fix)
        echo "üõ†Ô∏è –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º DNS –¥–ª—è VPN..."
        # –û—Ç–∫–ª—é—á–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ DNS –≤ NetworkManager
        if ! grep -q '^dns=none' /etc/NetworkManager/NetworkManager.conf; then
            echo -e "\n[main]\ndns=none" >> /etc/NetworkManager/NetworkManager.conf
        fi
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º Cloudflare DNS
        echo -e "nameserver 1.1.1.1\nnameserver 1.0.0.1" > /etc/resolv.conf
        systemctl restart NetworkManager
        echo "‚úÖ DNS –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å VPN"
        ;;
    restore)
        echo "üîÑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ DNS..."
        # –£–±–∏—Ä–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É dns=none
        sed -i '/^dns=none$/d' /etc/NetworkManager/NetworkManager.conf
        sed -i '/^\[main\]$/d' /etc/NetworkManager/NetworkManager.conf
        systemctl restart NetworkManager
        echo "‚úÖ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ DNS –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
        ;;
    *)
        echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: sudo $0 {fix|restore}"
        exit 1
        ;;
esac
